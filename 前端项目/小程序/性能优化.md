#   小程序性能优化

### 下载和加载环节

---

>   控制代码包大小
```
    -   精简代码,清楚无用代码
    -   减少在代码包中直接嵌入的资源文件
    -   图片放在cdn,使用适当的图片格式
    -   分包加载
```

>   小程序的分包加载(小程序使用分包时,主包是启动时加载的,分包是按需加载)
```
    小程序分包分为普通分包和独立分包.
    
    普通分包:   从分包页面启动时,依赖于主包的下载和注入。
    独立分包:   从独立分包页面启动，只下载和注入分包就可以打开页面。

    使用方案:    将常用的内容放到主包,不常用的内容放到分包
    
    存在的问题:  分包首次加载需要下载资源,会造成页面卡顿
```

>   解决分包页面的卡顿问题
```
    使用方案:   配置preloadRule,设置分包预加载,打开首页加载完主包后,静默加载分包
```

### 初始化首页环节

---

```
    1.  提前请求:   
        -   在页面onLoad阶段就可以发起异步请求,不用等页面ready.
        -   在前置页面点击跳转时预请求当前页的核心异步请求.

    2.  善用缓存:
        -   缓存变动频率低的数据,下次启动直接使用

    3.  优化交互:
        -   渲染期间,使用loading或骨架屏
```

### setData优化

--- 

```
    原理: 微信小程序是双线程模型
         视图层使用webview作为渲染载体
         逻辑层是由独立的javascriptcore作为运行环境
         两层通过native的jsbridge做中转

    流程:
        1.调用setData方法
        2.逻辑层执行一次JSON.stringify去除setData中不可传输的部分,将待传输数据转换成字符串拼接到特定的脚本,并将脚本传输到渲染层
        3.渲染层接收到数据,对脚本进行编译,得到待更新数据,进入渲染队列等待webview空闲渲染
        4.webview开始渲染,将data和setData数据套用到wxml片段上,得到一个新的节点树,与当前节点树diff，将差异部分更新,最后将setData合并到data中,并用新节点树替换旧节点树.
    
    问题:
        1.一次setData带来的开销,通信的开销+webview更新的开销，setData是小程序中操作比较频繁的api，最容易引发性能问题.

    解决:
        1.与界面渲染无关的数据最好不要设置在data中,可以考虑设置到page中
        2.将多次setData合并为一次setData调用
        3.列表某一项更新时,使用局部更新,只更新那一项就好,不必更新整个数组
        4.合理使用小程序组件,自定义组件的更新只在组件内部进行,不会影响到其他元素
```

### 性能分析工具

--- 

```
    1.trace工具
    2.性能面板
    3.加载性能监控 启动总耗时,下载耗时,初次渲染耗时
```
